@{
    ViewData["Title"] = "Live Map";
}

<div class="relative h-[calc(100vh-8rem)] w-full rounded-xl overflow-hidden shadow-lg border border-gray-200 bg-gray-100">
    <!-- Map Container -->
    <div id="map" class="h-full w-full z-0"></div>

    <!-- Floating Controls (Top Left) -->
    <div class="absolute top-4 left-4 z-[1000] flex flex-col gap-2">
        <div class="bg-white/90 backdrop-blur-sm p-2 rounded-lg shadow-md border border-gray-100">
            <h1 class="text-sm font-bold text-gray-800 px-2 uppercase tracking-wide">Network Map</h1>
        </div>
        
        <div class="bg-white/90 backdrop-blur-sm p-1 rounded-lg shadow-md border border-gray-100 flex flex-col gap-1">
            <button id="toggleStops" class="flex items-center gap-2 px-3 py-2 rounded-md hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition-colors text-sm font-medium">
                <i class="fas fa-map-marker-alt w-4 text-center"></i>
                <span>Stops</span>
            </button>
            <button id="toggleRoutes" class="flex items-center gap-2 px-3 py-2 rounded-md hover:bg-green-50 text-gray-700 hover:text-green-600 transition-colors text-sm font-medium">
                <i class="fas fa-route w-4 text-center"></i>
                <span>Routes</span>
            </button>
        </div>
    </div>

    <!-- Floating Stats (Bottom Right) -->
    <div class="absolute bottom-8 right-4 z-[1000]">
        <div class="bg-white/90 backdrop-blur-sm px-4 py-3 rounded-lg shadow-md border border-gray-100 text-xs text-gray-600 flex gap-4">
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-blue-600"></span>
                <span id="stopCount">Loading stops...</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                <span id="routeCount">Loading routes...</span>
            </div>
        </div>
    </div>
    
    <!-- Fit Bounds Button (Bottom Right above stats) -->
    <div class="absolute bottom-20 right-4 z-[1000]">
        <button id="fitBounds" class="bg-white/90 backdrop-blur-sm w-10 h-10 rounded-lg shadow-md border border-gray-100 flex items-center justify-center text-gray-700 hover:text-indigo-600 hover:bg-white transition-all">
            <i class="fas fa-expand"></i>
        </button>
    </div>
</div>

@section Scripts {
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // Initialize map with a clean, light tile layer (CartoDB Positron)
        const map = L.map('map', {
            zoomControl: false // We'll add it manually if needed, or rely on scroll/pinch
        }).setView([-25.7479, 28.2293], 10);

        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // Layer groups
        const stopsLayer = L.layerGroup().addTo(map);
        const routesLayer = L.layerGroup().addTo(map);

        let stopMarkers = [];
        let routeLines = [];

        // Fetch Data
        Promise.all([
            fetch('/Map/GetStops').then(r => r.json()),
            fetch('/Map/GetShapes').then(r => r.json())
        ]).then(([stops, shapes]) => {
            
            // Process Stops
            stops.forEach(stop => {
                const marker = L.circleMarker([stop.lat, stop.lon], {
                    radius: 5,
                    fillColor: '#3B82F6', // blue-500
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                });

                marker.bindPopup(`
                    <div class="font-sans">
                        <h4 class="font-bold text-gray-900 text-sm mb-1">${stop.name}</h4>
                        <div class="text-xs text-gray-500 space-y-1">
                            <p><span class="font-medium">ID:</span> ${stop.gtfsId}</p>
                            <p class="font-mono bg-gray-50 p-1 rounded inline-block">${stop.lat.toFixed(5)}, ${stop.lon.toFixed(5)}</p>
                        </div>
                    </div>
                `);
                
                stopsLayer.addLayer(marker);
                stopMarkers.push(marker);
            });
            document.getElementById('stopCount').textContent = `${stops.length} Stops`;

            // Process Routes
            const groupedShapes = {};
            shapes.forEach(point => {
                if (!groupedShapes[point.shapeId]) groupedShapes[point.shapeId] = [];
                groupedShapes[point.shapeId].push([point.lat, point.lon]);
            });

            Object.entries(groupedShapes).forEach(([shapeId, coords]) => {
                if (coords.length > 1) {
                    const polyline = L.polyline(coords, {
                        color: '#10B981', // emerald-500
                        weight: 3,
                        opacity: 0.8,
                        lineCap: 'round',
                        lineJoin: 'round'
                    });
                    
                    polyline.bindPopup(`
                        <div class="font-sans">
                            <h4 class="font-bold text-gray-900 text-sm">Route Shape</h4>
                            <p class="text-xs text-gray-500">ID: ${shapeId}</p>
                        </div>
                    `);

                    routesLayer.addLayer(polyline);
                    routeLines.push(polyline);
                }
            });
            document.getElementById('routeCount').textContent = `${Object.keys(groupedShapes).length} Routes`;

            // Initial Fit
            fitMapToMarkers();

        }).catch(err => console.error('Error loading map data:', err));

        // Controls
        document.getElementById('toggleStops').addEventListener('click', function() {
            if (map.hasLayer(stopsLayer)) {
                map.removeLayer(stopsLayer);
                this.classList.add('opacity-50');
            } else {
                map.addLayer(stopsLayer);
                this.classList.remove('opacity-50');
            }
        });

        document.getElementById('toggleRoutes').addEventListener('click', function() {
            if (map.hasLayer(routesLayer)) {
                map.removeLayer(routesLayer);
                this.classList.add('opacity-50');
            } else {
                map.addLayer(routesLayer);
                this.classList.remove('opacity-50');
            }
        });

        document.getElementById('fitBounds').addEventListener('click', fitMapToMarkers);

        function fitMapToMarkers() {
            if (stopMarkers.length > 0) {
                const group = new L.featureGroup(stopMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
    </script>
}
